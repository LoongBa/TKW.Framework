@using System.Linq
@using System.Collections.Generic
@using xCodeGen.Abstractions.Metadata
@model xCodeGen.Abstractions.Metadata.ClassMetadata
@{
    // 1. 变量准备
    var cls = Model.ClassName;
    var ns = Model.Namespace;
    var summary = Model.Summary;
    var serviceName = cls + "Service";

    // 2. 获取自定义参数 (读取 GenerateCodeSettings)
    if (Model.GenerateCodeSettings == null)
        throw new InvalidOperationException("无法获取元数据中的 GenerateCodeSettings。");

    if (!Model.GenerateCodeSettings.TryGetValue("BaseUserType", out var userTypeObj) || userTypeObj == null)
        throw new ArgumentException("CustomSettings 中缺失关键配置项: BaseUserType。");

    var userType = Raw(userTypeObj.ToString());

    // 3. 属性识别 (主键与类型识别)
    var pkProperty = Model.Properties.FirstOrDefault(p => 
        p.Attributes.Any(a => a.Name.Contains("PrimaryKey")) || 
        p.Name.Equals("Id", StringComparison.OrdinalIgnoreCase));
    
    // 采用 TypeName 作为类型标识
    var pkTypeStr = pkProperty?.TypeName ?? "long"; 
    var pkType = Raw(pkTypeStr);
    var pkName = pkProperty?.Name ?? "Id";

    var hasIsDeleted = Model.Properties.Any(p => p.Name == "IsDeleted");
    var hasTenantId = Model.Properties.Any(p => p.Name == "TenantId");
    
    // 命名空间处理
    var serviceNamespace = Raw(Model.Namespace.Replace(".Models", ".Services"));
}
// <auto-generated>
// 此文件由 xCodeGen 自动生成，请勿手动修改。
// </auto-generated>

using System;
using System.Threading;
using System.Threading.Tasks;
using FreeSql;
using TKW.Framework.Domain;
using @ns;
using @(ns).DTOs;

namespace @serviceNamespace;

/// <summary>
/// @(summary) 的领域服务基础实现
/// </summary>
public partial class @serviceName : DomainServiceBase<@userType>
{
    protected readonly IFreeSql _fsql;
    protected IBaseRepository<@cls> Repo => _fsql.GetRepository<@cls>();

    public @(serviceName)(DomainUser<@userType> user, IFreeSql fsql) : base(user)
    {
        _fsql = fsql ?? throw new ArgumentNullException(nameof(fsql));
    }

    public ISelect<@cls> QueryForUser()
    {
        var q = Repo.Select;
@if (hasIsDeleted)
{
        @:q = q.Where(x => !x.IsDeleted);
}
@if (hasTenantId)
{
        @:if (User.Info?.TenantId != null)
        @:{
        @:    q = q.Where(x => x.TenantId == User.Info.TenantId);
        @:}
}
        OnQueryFiltering(ref q);
        return q;
    }

    public Task<@cls> GetByIdAsync(@pkType id, CancellationToken ct = default)
        => QueryForUser().Where(x => x.@pkName == id).FirstAsync(ct);

    public async Task<@cls> CreateAsync(@cls entity, CancellationToken ct = default)
    {
        OnBeforeCreate(entity);
        await Repo.InsertAsync(entity, ct);
        OnAfterCreate(entity);
        return entity;
    }

    public async Task UpdateAsync(@cls entity, CancellationToken ct = default)
    {
        OnBeforeUpdate(entity);
        await Repo.UpdateAsync(entity, ct);
        OnAfterUpdate(entity);
    }

    // ───────────────────────────────────────────────────────────────
    // 钩子声明
    // ───────────────────────────────────────────────────────────────

    partial void OnQueryFiltering(ref ISelect<@cls> query);
    partial void OnBeforeCreate(@cls entity);
    partial void OnAfterCreate(@cls entity);
    partial void OnBeforeUpdate(@cls entity);
    partial void OnAfterUpdate(@cls entity);
}