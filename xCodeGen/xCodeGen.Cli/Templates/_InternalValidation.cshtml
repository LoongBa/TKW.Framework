@using System.Linq
@using xCodeGen.Abstractions
@using xCodeGen.Abstractions.Metadata
@model ClassMetadata
@{
    // 判定类型：1 为 DTO 校验，2 为 Model 校验
    int checkType = !Model.ClassName.EndsWith("Dto") ? 2 : 1;
}
        // 运行时通过 ProjectMetaContext 构建字典
        var _propMap = ProjectMetaContext.Instance.FindByClassName("@Model.ClassName").Properties.ToDictionary(x => x.Name);

@foreach (var p in Model.Properties)
{
    if (CodeGenPolicy.IsAutoManaged(p)) continue; 

    var dtoAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("DtoFieldAttribute"));
    var fieldLabel = Raw(CodeGenPolicy.GetStringProp(dtoAttr, "DisplayName") ?? (string.IsNullOrWhiteSpace(p.Summary) ? p.Name : p.Summary));

@:    if (CodeGenPolicy.CanProcess(_propMap, "@p.Name", scene, this.IsFromPersistentSource, @checkType))
@:    {
        var colAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("ColumnAttribute"));
        int slen = CodeGenPolicy.GetIntProp(colAttr, "StringLength", 0); 
        if (slen > 0)
        {
@:        if (this.@(p.Name)?.Length > @slen) yield return new ValidationResult("@(fieldLabel) 长度超限 (@slen)", new[] { "@p.Name" });
        }

        if (p.Attributes.Any(a => a.TypeFullName.Contains("RequiredAttribute")) || CodeGenPolicy.GetBoolProp(dtoAttr, "IsRequired", false))
        {
@:        if (string.IsNullOrWhiteSpace(this.@p.Name)) yield return new ValidationResult("@(fieldLabel) 不能为空", new[] { "@p.Name" });
        }
@:    }
}