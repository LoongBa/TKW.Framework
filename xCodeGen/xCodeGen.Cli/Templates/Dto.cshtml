@using System.Linq
@using xCodeGen.Abstractions.Metadata
@model xCodeGen.Abstractions.Metadata.ClassMetadata
@{
    var dtoClassName = Model.ClassName + "Dto";
    // 过滤掉标记为 DtoIgnore 的属性
    var dtoProps = Model.Properties.Where(p => !p.Attributes.Any(a => a.TypeFullName.Contains("DtoIgnore"))).ToList();
}
// <auto-generated>
    // 此文件由 xCodeGen 自动生成，请勿手动修改。
    // 生成时间: @DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")
    //
</auto-generated>

using System;
using TKW.Framework.Domain.Interception.Filters;
using @Model.Namespace;

namespace @(Model.Namespace).DTOs;

/// <summary>
    /// @(Model.Summary) 的数据传输对象 (Record)
    ///
</summary>
public partial record @(dtoClassName) (
@for (int i = 0; i < dtoProps.Count; i++)
{
    var p = dtoProps[i];
    @:    @(p.TypeName) @(p.Name)@(i < dtoProps.Count - 1 ? "," : "") // @(p.Summary)
}
)
{
    /// <summary>
    /// 将 DTO 数据应用到实体对象 (职责倒置)
    ///
</summary>
    public void ApplyToEntity(@(Model.ClassName) entity, EnumSceneFlags scene = EnumSceneFlags.Update)
    {
@foreach (var p in dtoProps)
{
    // 查找 DtoFieldAttribute 元数据
    var dtoAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("DtoFieldAttribute"));
    bool isUpdateReadOnly = false;

    if (dtoAttr != null && dtoAttr.Properties.TryGetValue("UpdateReadOnly", out var val))
    {
        isUpdateReadOnly = (bool)val;
    }

    if (isUpdateReadOnly)
    {
        @:if (scene != EnumSceneFlags.Update) { entity.@(p.Name) = this.@(p.Name); }
    }
    else
    {
        // 排除主键 Id 不被误修改
        if (p.Name != "Id")
        {
            @:entity.@(p.Name) = this.@(p.Name);
        }
    }
}

        OnApplyCustomMapping(entity, scene);
    }

    /// <summary>
    /// 从实体创建 DTO (静态工厂)
    ///
</summary>
    public static @(dtoClassName) FromEntity(@(Model.ClassName) entity)
    {
        return new @(dtoClassName) (
@for (int i = 0; i < dtoProps.Count; i++)
{
    var p = dtoProps[i];
    @:    entity.@(p.Name)@(i < dtoProps.Count - 1 ? "," : "")
}
        );
    }

    partial void OnApplyCustomMapping(@(Model.ClassName) entity, EnumSceneFlags scene);
}