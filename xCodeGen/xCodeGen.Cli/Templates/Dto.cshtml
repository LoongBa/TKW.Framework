@using System.Linq
@using xCodeGen.Abstractions
@using xCodeGen.Abstractions.Metadata
@model ClassMetadata
@{
    var dtoClassName = Model.ClassName + "Dto";
    var generatedNs = Model.GenerateCodeSettings["GeneratedNamespace"]?.ToString();
    string metaHash = Model.GenerateCodeSettings?.ContainsKey("MetadataHash") == true 
        ? Model.GenerateCodeSettings["MetadataHash"]?.ToString() : "N/A";
    var timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");

    var dtoProps = Model.Properties
        .Where(p => !p.Attributes.Any(a => a.TypeFullName.Contains("DtoIgnore")))
        .OrderBy(p => CodeGenPolicy.GetIntProp(p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("ColumnAttribute")), "Position", 999))
        .ToList();
}
// <auto-generated>
// 此文件由 xCodeGen 自动生成，请勿手动修改。
// @@[xCodeGen.Hash: @metaHash]
// 模型: @Model.ClassName (@Model.FullName)
// 生成时间: @timestamp
// </auto-generated>

using System;
using System.Collections.Generic;
using System.Linq;
using System.ComponentModel.DataAnnotations;
using TKW.Framework.Domain.Interfaces;
using TKW.Framework.Domain;
using TKW.Framework.Common.Exceptions;
using xCodeGen.Abstractions;
using @generatedNs;
using @Model.Namespace;

namespace @(Model.Namespace).DTOs;

public partial record @dtoClassName : DomainDtoBase<@Model.ClassName>, IValidatableObject
{
    #region 属性定义
@foreach (var p in dtoProps)
{
@:    /// <summary> @Raw(string.IsNullOrWhiteSpace(p.Summary) ? p.Name : p.Summary) </summary>
@:    public @(p.TypeName) @(p.Name) { get; init; }
}
    #endregion

    #region 映射逻辑

    public static @dtoClassName FromEntity(@Model.ClassName entity, EnumSceneFlags scene = EnumSceneFlags.Details)
    {
        ArgumentNullException.ThrowIfNull(entity);
        return new @dtoClassName 
        {
@foreach (var p in dtoProps)
{
    var dtoAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("DtoFieldAttribute"));
    if (CodeGenPolicy.GetBoolProp(dtoAttr, "Masking", false))
    {
        var pattern = CodeGenPolicy.GetStringProp(dtoAttr, "MaskPattern") ?? "";
@:            @(p.Name) = MaskHelper.GetMaskedValue(entity.@(p.Name), "@pattern"),
    }
    else
    {
@:            @(p.Name) = entity.@(p.Name),
    }
}
        };
    }

    public override @Model.ClassName ApplyToEntity(@Model.ClassName entity, EnumSceneFlags scene = EnumSceneFlags.Update)
    {
        ArgumentNullException.ThrowIfNull(entity);
        var _propMap = ProjectMetaContext.Instance.FindByClassName("@Model.ClassName").Properties.ToDictionary(x => x.Name);

@foreach (var p in dtoProps)
{
    if (new[] { "Id", "CreateTime", "UpdateTime" }.Contains(p.Name)) continue;

@:    if (CodeGenPolicy.CanProcess(_propMap, "@p.Name", scene, false, 0))
@:    {
        var dtoAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("DtoFieldAttribute"));
        if (CodeGenPolicy.GetBoolProp(dtoAttr, "Masking", false)) 
        {
            var pattern = CodeGenPolicy.GetStringProp(dtoAttr, "MaskPattern") ?? ""; 
@:        var maskedValue = MaskHelper.GetMaskedValue(entity.@(p.Name), "@pattern");
@:        if (this.@(p.Name) != maskedValue) entity.@(p.Name) = this.@(p.Name);
        }
        else
        {
@:        entity.@(p.Name) = this.@(p.Name);
        }
@:    }
}
        return entity;
    }

    #endregion

    #region 验证逻辑

    public override void ValidateData(EnumSceneFlags scene)
    {
        if (IsFromPersistentSource && (scene & EnumSceneFlags.ForceValidate) == 0) return;
        var results = ValidateDataCore(scene).ToList();
        OnCustomValidate(scene, results);

        if (results.Any()) throw new ValidationResultsException(results);
    }

    protected IEnumerable<ValidationResult> ValidateDataCore(EnumSceneFlags scene)
    {
        @{ await IncludeAsync("_InternalValidation.cshtml", Model); }
        yield break;
    }

    public IEnumerable<ValidationResult> Validate(ValidationContext validationContext) => ValidateDataCore(EnumSceneFlags.Create);

    partial void OnCustomValidate(EnumSceneFlags scene, List<ValidationResult> results);

    #endregion
}