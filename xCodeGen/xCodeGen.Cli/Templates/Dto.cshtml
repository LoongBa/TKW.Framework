@using System.Linq
@using xCodeGen.Abstractions.Metadata
@model xCodeGen.Abstractions.Metadata.ClassMetadata
@{
    var dtoClassName = Model.ClassName + "Dto";
    var ns = Model.Namespace;
    
    var dtoProps = Model.Properties
        .Where(p => !p.Attributes.Any(a => a.TypeFullName.Contains("DtoIgnore")))
        .OrderBy(p => {
            var col = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("ColumnAttribute"));
            return col?.Properties.ContainsKey("Position") == true ? (int)col.Properties["Position"] : 999;
        }).ToList();

    string metaHash = "N/A"; // 统一获取由引擎注入的稳定哈希
    if (Model.GenerateCodeSettings != null && Model.GenerateCodeSettings.ContainsKey("MetadataHash"))
    {
        metaHash = Model.GenerateCodeSettings["MetadataHash"]?.ToString() ?? "N/A";
    }
    var timestamp = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
}
// <auto-generated>
// 此文件由 xCodeGen 自动生成，请勿手动修改。
// @@[xCodeGen.Hash: @metaHash]
// 模型: @Model.ClassName (@Model.FullName)
// 生成时间: @timestamp
// </auto-generated>

using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using TKW.Framework.Common.Enumerations;
using TKW.Framework.Domain.Interception.Filters;
using @ns;

namespace @(ns).DTOs;

/// <summary>
/// @(string.IsNullOrWhiteSpace(Model.Summary) ? Model.ClassName + " DTO" : Raw(Model.Summary))
/// </summary>
public partial record @dtoClassName
{
    #region 属性定义
@foreach (var p in dtoProps)
{
    @:    /// <summary> @(string.IsNullOrWhiteSpace(p.Summary) ? p.Name : Raw(p.Summary)) </summary>
    @:    public @(p.TypeName) @(p.Name) { get; init; }
}
    #endregion

    #region 静态转换与复制

    public static @dtoClassName FromEntity(@Model.ClassName entity)
    {
        if (entity == null) return null;
        return new @dtoClassName 
        {
@foreach (var p in dtoProps)
{
            @:        @(p.Name) = entity.@(p.Name),
}
        };
    }

    public void ApplyToEntity(@Model.ClassName entity, EnumSceneFlags scene = EnumSceneFlags.Update)
    {
        if (entity == null) return;
@foreach (var p in dtoProps)
{
    if (p.Name == "Id" || p.Name == "CreateTime" || p.Name == "UpdateTime") continue;

    var dtoAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("DtoFieldAttribute"));
    bool isUpdateReadOnly = false;
    if (dtoAttr != null && dtoAttr.Properties.TryGetValue("UpdateReadOnly", out var val)) { isUpdateReadOnly = (bool)val; }

    if (isUpdateReadOnly)
    {
        @:        if (scene != EnumSceneFlags.Update) { entity.@(p.Name) = this.@(p.Name); }
    }
    else
    {
        @:        entity.@(p.Name) = this.@(p.Name);
    }
}
        OnApplyCustomMapping(entity, scene);
    }

    #endregion

    #region 自动化验证逻辑 (ValidateCore)

    protected void ValidateCore(EnumSceneFlags scene)
    {
@foreach (var p in dtoProps)
{
    var dtoAttr = p.Attributes.FirstOrDefault(a => a.TypeFullName.Contains("DtoFieldAttribute"));
    if (dtoAttr == null) continue;
    var fieldSummary = string.IsNullOrWhiteSpace(p.Summary) ? p.Name : p.Summary;

    if (dtoAttr.Properties.ContainsKey("CreateRequired") && (bool)dtoAttr.Properties["CreateRequired"])
    {
        @:        if (scene == EnumSceneFlags.Create && string.IsNullOrWhiteSpace(this.@p.Name)) 
        @:            throw new ValidationException("@Raw(fieldSummary) 不能为空");
    }
    
    if (dtoAttr.Properties.ContainsKey("RequiredScenes"))
    {
        var scenesVal = (int)dtoAttr.Properties["RequiredScenes"];
        if (scenesVal > 0)
        {
        @:        if (((int)scene & @scenesVal) != 0 && string.IsNullOrWhiteSpace(this.@p.Name))
        @:            throw new ValidationException("@(fieldSummary) 在当前场景下必填");
        }
    }
}
    }

    #endregion

    partial void OnApplyCustomMapping(@Model.ClassName entity, EnumSceneFlags scene);
}