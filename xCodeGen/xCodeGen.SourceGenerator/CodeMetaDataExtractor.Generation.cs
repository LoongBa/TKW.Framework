// CodeMetaDataExtractor.Generation.cs
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using xCodeGen.Abstractions.Metadata;

namespace xCodeGen.SourceGenerator
{
    public partial class CodeMetaDataExtractor
    {
        /// <summary>
        /// 生成元数据代码文件
        /// </summary>
        public void GenerateMetaFile(SourceProductionContext context, ClassMetadata metadata)
        {
            try
            {
                LogDebug($"开始生成元数据文件: {metadata.ClassName}");

                // 生成文件名: Meta/TestServiceMeta.g.cs
                var fileName = $"{MetaFilePrefix}{metadata.ClassName}Meta{GeneratedFileExtension}";

                // 构建代码内容
                var codeContent = BuildMetaCode(metadata);

                // 添加到生成结果
                context.AddSource(fileName, SourceText.From(codeContent, Encoding.UTF8));
                LogDebug($"元数据文件生成完成: {fileName}");
            }
            catch (Exception ex)
            {
                LogDebug($"生成元数据文件失败: {ex.Message}");
                ReportError(context, $"生成元数据时出错: {ex.Message}");
            }
        }

        // CodeMetaDataExtractor.Generation.cs（仅修改BuildMetaCode方法）
        /// <summary>
        /// 构建结构化元数据代码内容（可直接被模板引擎使用）
        /// </summary>
        private string BuildMetaCode(ClassMetadata metadata)
        {
            var codeBuilder = new StringBuilder();

            // 添加自动生成头部
            codeBuilder.AppendFormat(AutoGeneratedHeader, DateTime.UtcNow);

            // 引用必要的命名空间
            codeBuilder.AppendLine("using System;");
            codeBuilder.AppendLine("using System.Collections.Generic;");
            codeBuilder.AppendLine("using System.Collections.ObjectModel;");
            codeBuilder.AppendLine("using xCodeGen.Abstractions.Metadata;");
            codeBuilder.AppendLine();

            // 构建命名空间
            codeBuilder.AppendLine($"namespace {metadata.Namespace}.Generated;");
            codeBuilder.AppendLine();

            // 构建元数据类
            codeBuilder.AppendLine($"public partial class {metadata.ClassName}Meta");
            codeBuilder.AppendLine("{");
            codeBuilder.AppendLine("    /// <summary>");
            codeBuilder.AppendLine($"    /// {metadata.ClassName} 的结构化元数据");
            codeBuilder.AppendLine("    /// 可直接作为对象传递给模板引擎");
            codeBuilder.AppendLine("    /// </summary>");
            codeBuilder.AppendLine("    public static ClassMetadata Metadata { get; } = new ClassMetadata");
            codeBuilder.AppendLine("    {");

            // 填充类级元数据（新增基类和接口信息）
            codeBuilder.AppendLine($"        Namespace = \"{EscapeString(metadata.Namespace)}\",");
            codeBuilder.AppendLine($"        ClassName = \"{EscapeString(metadata.ClassName)}\",");
            codeBuilder.AppendLine($"        FullName = \"{EscapeString(metadata.FullName)}\",");
            codeBuilder.AppendLine($"        Mode = \"{EscapeString(metadata.Mode)}\",");
            codeBuilder.AppendLine($"        SourceType = \"{EscapeString(metadata.SourceType)}\",");
            codeBuilder.AppendLine($"        TemplateName = \"{EscapeString(metadata.TemplateName)}\",");
            codeBuilder.AppendLine($"        BaseType = \"{EscapeString(metadata.BaseType)}\","); // 新增基类
            codeBuilder.AppendLine("        ImplementedInterfaces = new Collection<string>"); // 新增接口列表
            codeBuilder.AppendLine("        {");
            foreach (var interFace in metadata.ImplementedInterfaces)
            {
                codeBuilder.AppendLine($"            \"{EscapeString(interFace)}\",");
            }
            codeBuilder.AppendLine("        },");

            // 填充方法集合
            codeBuilder.AppendLine("        Methods = new Collection<MethodMetadata>");
            codeBuilder.AppendLine("        {");
            foreach (var method in metadata.Methods)
            {
                codeBuilder.AppendLine("            new MethodMetadata");
                codeBuilder.AppendLine("            {");
                codeBuilder.AppendLine($"                Name = \"{EscapeString(method.Name)}\",");
                codeBuilder.AppendLine($"                ReturnType = \"{EscapeString(method.ReturnType)}\",");
                codeBuilder.AppendLine($"                IsAsync = {method.IsAsync.ToString().ToLower()},");
                codeBuilder.AppendLine($"                AccessModifier = \"{EscapeString(method.AccessModifier)}\",");

                // 填充参数集合
                codeBuilder.AppendLine("                Parameters = new List<ParameterMetadata>");
                codeBuilder.AppendLine("                {");
                foreach (var param in method.Parameters)
                {
                    codeBuilder.AppendLine("                    new ParameterMetadata");
                    codeBuilder.AppendLine("                    {");
                    codeBuilder.AppendLine($"                        Name = \"{EscapeString(param.Name)}\",");
                    codeBuilder.AppendLine($"                        TypeName = \"{EscapeString(param.TypeName)}\",");
                    codeBuilder.AppendLine($"                        TypeFullName = \"{EscapeString(param.TypeFullName)}\",");
                    codeBuilder.AppendLine($"                        IsNullable = {param.IsNullable.ToString().ToLower()},");
                    codeBuilder.AppendLine($"                        IsCollection = {param.IsCollection.ToString().ToLower()},");
                    codeBuilder.AppendLine($"                        CollectionItemType = {FormatStringValue(param.CollectionItemType)},");

                    // 填充参数特性
                    codeBuilder.AppendLine("                        Attributes = new List<AttributeMetadata>");
                    codeBuilder.AppendLine("                        {");
                    foreach (var attr in param.Attributes)
                    {
                        codeBuilder.AppendLine("                            new AttributeMetadata");
                        codeBuilder.AppendLine("                            {");
                        codeBuilder.AppendLine($"                                TypeFullName = {FormatStringValue(attr.TypeFullName)},");
                        codeBuilder.AppendLine("                                Properties = new Dictionary<string, object>");
                        codeBuilder.AppendLine("                                {");
                        foreach (var prop in attr.Properties)
                        {
                            codeBuilder.AppendLine($"                                    {{ \"{EscapeString(prop.Key)}\", {GetLiteralValue(prop.Value)} }} ,");
                        }
                        codeBuilder.AppendLine("                                }");
                        codeBuilder.AppendLine("                            },");
                    }
                    codeBuilder.AppendLine("                        }");
                    codeBuilder.AppendLine("                    },");
                }
                codeBuilder.AppendLine("                }");
                codeBuilder.AppendLine("            },");
            }
            codeBuilder.AppendLine("        }");
            codeBuilder.AppendLine("    };");
            codeBuilder.AppendLine("}");

            return codeBuilder.ToString();
        }

        /// <summary>
        /// 生成元数据收集器（汇总所有类的元数据）
        /// </summary>
        public void GenerateMetaCollector(SourceProductionContext context, IEnumerable<ClassMetadata> allMetadatas)
        {
            try
            {
                LogDebug("开始生成元数据收集器 MetaCollector");

                var codeBuilder = new StringBuilder();
                // 添加自动生成头部和可空指令
                codeBuilder.AppendFormat(AutoGeneratedHeader, DateTime.UtcNow);
                codeBuilder.AppendLine("#nullable disable"); // 新增：解决可空类型批注警告
                codeBuilder.AppendLine();

                // 引用必要的命名空间
                codeBuilder.AppendLine("using System;");
                codeBuilder.AppendLine("using System.Collections.Generic;");
                codeBuilder.AppendLine("using System.Linq;");
                codeBuilder.AppendLine("using xCodeGen.Abstractions.Metadata;");
                codeBuilder.AppendLine();

                // 构建命名空间（使用基础命名空间）
                var baseNamespace = "xCodeGen.Generated";
                codeBuilder.AppendLine($"namespace {baseNamespace};");
                codeBuilder.AppendLine();

                // 构建 MetaCollector 类
                codeBuilder.AppendLine("public static class MetaCollector");
                codeBuilder.AppendLine("{");
                codeBuilder.AppendLine("    /// <summary>");
                codeBuilder.AppendLine("    /// 所有类型的元数据集合");
                codeBuilder.AppendLine("    /// </summary>");
                codeBuilder.AppendLine("    public static IReadOnlyList<ClassMetadata> AllMetadatas { get; } = new List<ClassMetadata>");
                codeBuilder.AppendLine("    {");

                // 修正命名空间引用：去掉多余的 Generated 层级
                foreach (var metadata in allMetadatas)
                {
                    var metaClassName = $"{metadata.ClassName}Meta";
                    // 原错误代码：{metadata.Namespace}.Generated.Generated.{metaClassName}.Metadata
                    codeBuilder.AppendLine($"        {metadata.Namespace}.Generated.{metaClassName}.Metadata,");
                }

                codeBuilder.AppendLine("    };");
                codeBuilder.AppendLine();
                codeBuilder.AppendLine("    /// <summary>");
                codeBuilder.AppendLine("    /// 根据类名查找元数据");
                codeBuilder.AppendLine("    /// </summary>");
                codeBuilder.AppendLine("    public static ClassMetadata? FindByClassName(string className)");
                codeBuilder.AppendLine("    {");
                codeBuilder.AppendLine("        return AllMetadatas.FirstOrDefault(m => m.ClassName == className);");
                codeBuilder.AppendLine("    }");
                codeBuilder.AppendLine();
                codeBuilder.AppendLine("    /// <summary>");
                codeBuilder.AppendLine("    /// 根据命名空间查找元数据");
                codeBuilder.AppendLine("    /// </summary>");
                codeBuilder.AppendLine("    public static IEnumerable<ClassMetadata> FindByNamespace(string @namespace)");
                codeBuilder.AppendLine("    {");
                codeBuilder.AppendLine("        return AllMetadatas.Where(m => m.Namespace == @namespace);");
                codeBuilder.AppendLine("    }");
                codeBuilder.AppendLine("}");

                // 输出文件
                context.AddSource("Meta/MetaCollector.g.cs",
                    SourceText.From(codeBuilder.ToString(), Encoding.UTF8));
                LogDebug("元数据收集器生成完成");
            }
            catch (Exception ex)
            {
                LogDebug($"生成元数据收集器失败: {ex.Message}");
                ReportError(context, $"生成 MetaCollector 时出错: {ex.Message}");
            }
        }

        /// <summary>
        /// 转义字符串中的特殊字符
        /// </summary>
        private string EscapeString(string value)
        {
            return value?.Replace("\\", "\\\\").Replace("\"", "\\\"") ?? string.Empty;
        }

        /// <summary>
        /// 格式化字符串值（处理null情况）
        /// </summary>
        private string FormatStringValue(string value)
        {
            return value == null ? "null" : $"\"{EscapeString(value)}\"";
        }

        /// <summary>
        /// 将对象值转换为C#字面量
        /// </summary>
        private string GetLiteralValue(object value)
        {
            if (value == null) return "null";
            if (value is string s) return $"\"{EscapeString(s)}\"";
            if (value is bool b) return b.ToString().ToLower();
            if (value is int i) return i.ToString();
            if (value is long l) return l.ToString();
            if (value is double d) return d.ToString();
            if (value is DateTime dt) return $"new DateTime({dt.Ticks}, DateTimeKind.Utc)";
            return $"\"{EscapeString(value.ToString())}\"";
        }
        /// <summary>
        /// 生成调试日志接口文件
        /// </summary>
        public void GenerateDebugLogFile(SourceProductionContext context)
        {
            var logContent = new StringBuilder();
            logContent.AppendLine("// <auto-generated> 代码生成调试日志 </auto-generated>");
            logContent.AppendLine("using System;");
            logContent.AppendLine("using System.Collections.Generic;");
            logContent.AppendLine();
            logContent.AppendLine($"namespace {DebugLogNamespace} {{");
            logContent.AppendLine("    /// <summary>");
            logContent.AppendLine("    /// 代码生成过程调试日志接口");
            logContent.AppendLine("    /// </summary>");
            logContent.AppendLine($"    public interface {DebugLogInterfaceName} {{");
            logContent.AppendLine("        /// <summary>日志记录总数</summary>");
            logContent.AppendLine($"        int TotalLogs => {_debugLogs.Count};");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>生成开始时间</summary>");
            logContent.AppendLine($"        DateTime StartTime => DateTime.Parse(\"{(_debugLogs.Count > 0 ? _debugLogs[0].Split(']')[0].TrimStart('[') : "00:00:00.000")}\");");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>生成结束时间</summary>");
            logContent.AppendLine($"        DateTime EndTime => DateTime.Parse(\"{(_debugLogs.Count > 0 ? _debugLogs.Last().Split(']')[0].TrimStart('[') : "00:00:00.000")}\");");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>执行时长（毫秒）</summary>");
            logContent.AppendLine($"        long DurationMs => (long)(EndTime - StartTime).TotalMilliseconds;");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>是否包含错误</summary>");
            logContent.AppendLine($"        bool HasErrors => {_debugLogs.Any(l => l.Contains("错误:")).ToString().ToLower()};");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>详细日志条目</summary>");
            logContent.AppendLine("        IEnumerable<string> LogEntries => new List<string> {");

            // 添加日志条目
            foreach (var log in _debugLogs)
            {
                logContent.AppendLine($"            \"{log.Replace("\"", "\\\"")}\",");
            }

            logContent.AppendLine("        };");
            logContent.AppendLine("    }");
            logContent.AppendLine("}");

            context.AddSource("Logs/CodeMetaData_DebugLog.g.cs",
                SourceText.From(logContent.ToString(), Encoding.UTF8));
        }

        /// <summary>
        /// 报告生成错误
        /// </summary>
        private void ReportError(SourceProductionContext context, string message)
        {
            context.ReportDiagnostic(Diagnostic.Create(
                new DiagnosticDescriptor(
                    "CMD001", "元数据生成错误", message, "CodeMeta",
                    DiagnosticSeverity.Error, true),
                Location.None));
        }

        /// <summary>
        /// 带上下文的日志记录（支持诊断输出）
        /// </summary>
        private void LogDebug(SourceProductionContext context, string message)
        {
            LogDebug(message);
            context.ReportDiagnostic(Diagnostic.Create(
                new DiagnosticDescriptor(
                    "CMD000", "元数据生成调试", message, "CodeMeta",
                    DiagnosticSeverity.Info, true),
                Location.None));
        }
    }
}