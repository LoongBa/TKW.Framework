// CodeMetaDataExtractor.Generation.cs
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;
using System;
using System.Linq;
using System.Text;
using xCodeGen.Abstractions.Metadata;

namespace xCodeGen.SourceGenerator
{
    public partial class CodeMetaDataExtractor
    {
        /// <summary>
        /// 生成元数据代码文件
        /// </summary>
        public void GenerateMetaFile(SourceProductionContext context, ClassMetadata metadata)
        {
            try
            {
                LogDebug($"开始生成元数据文件: {metadata.ClassName}");

                // 生成文件名: Meta/TestServiceMeta.g.cs
                var fileName = $"{MetaFilePrefix}{metadata.ClassName}Meta{GeneratedFileExtension}";

                // 构建代码内容
                var codeContent = BuildMetaCode(metadata);

                // 添加到生成结果
                context.AddSource(fileName, SourceText.From(codeContent, Encoding.UTF8));
                LogDebug($"元数据文件生成完成: {fileName}");
            }
            catch (Exception ex)
            {
                LogDebug($"生成元数据文件失败: {ex.Message}");
                ReportError(context, $"生成元数据时出错: {ex.Message}");
            }
        }

        /// <summary>
        /// 构建元数据代码内容
        /// </summary>
        private string BuildMetaCode(ClassMetadata metadata)
        {
            var codeBuilder = new StringBuilder();

            // 添加自动生成头部
            codeBuilder.AppendFormat(AutoGeneratedHeader, DateTime.UtcNow);

            // 构建类内容
            var classContent = new StringBuilder();
            classContent.AppendLine("        // 类元数据信息");
            classContent.AppendLine($"        public const string ClassName = \"{metadata.ClassName}\";");
            classContent.AppendLine($"        public const string FullName = \"{metadata.FullName}\";");
            classContent.AppendLine($"        public const string Namespace = \"{metadata.Namespace}\";");
            classContent.AppendLine();
            classContent.AppendLine("        // 方法数量");
            classContent.AppendLine($"        public const int MethodCount = {metadata.Methods.Count};");

            // 补充方法元数据
            var methods = metadata.Methods.ToList(); // 转换为List以支持索引访问
            for (int i = 0; i < methods.Count; i++)
            {
                var method = methods[i];
                classContent.AppendLine();
                classContent.AppendLine($"        // 方法 {i + 1}: {method.Name}");
                classContent.AppendLine($"        public const string Method{i + 1}Name = \"{method.Name}\";");
                classContent.AppendLine($"        public const string Method{i + 1}ReturnType = \"{method.ReturnType}\";");
                classContent.AppendLine($"        public const bool Method{i + 1}IsAsync = {method.IsAsync.ToString().ToLower()};");
                classContent.AppendLine($"        public const string Method{i + 1}AccessModifier = \"{method.AccessModifier}\";");
                classContent.AppendLine($"        public const int Method{i + 1}ParameterCount = {method.Parameters.Count};");
            }

            // 构建命名空间和类
            var formattedClass = string.Format(ClassTemplate, metadata.ClassName, classContent);
            var formattedNamespace = string.Format(NamespaceTemplate, metadata.Namespace, formattedClass);

            codeBuilder.Append(formattedNamespace);
            return codeBuilder.ToString();
        }

        /// <summary>
        /// 生成调试日志接口文件
        /// </summary>
        public void GenerateDebugLogFile(SourceProductionContext context)
        {
            var logContent = new StringBuilder();
            logContent.AppendLine("// <auto-generated> 代码生成调试日志 </auto-generated>");
            logContent.AppendLine("using System;");
            logContent.AppendLine("using System.Collections.Generic;");
            logContent.AppendLine();
            logContent.AppendLine($"namespace {DebugLogNamespace} {{");
            logContent.AppendLine("    /// <summary>");
            logContent.AppendLine("    /// 代码生成过程调试日志接口");
            logContent.AppendLine("    /// </summary>");
            logContent.AppendLine($"    public interface {DebugLogInterfaceName} {{");
            logContent.AppendLine("        /// <summary>日志记录总数</summary>");
            logContent.AppendLine($"        int TotalLogs => {_debugLogs.Count};");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>生成开始时间</summary>");
            logContent.AppendLine($"        DateTime StartTime => DateTime.Parse(\"{(_debugLogs.Count > 0 ? _debugLogs[0].Split(']')[0].TrimStart('[') : "00:00:00.000")}\");");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>生成结束时间</summary>");
            logContent.AppendLine($"        DateTime EndTime => DateTime.Parse(\"{(_debugLogs.Count > 0 ? _debugLogs.Last().Split(']')[0].TrimStart('[') : "00:00:00.000")}\");");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>执行时长（毫秒）</summary>");
            logContent.AppendLine($"        long DurationMs => (long)(EndTime - StartTime).TotalMilliseconds;");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>是否包含错误</summary>");
            logContent.AppendLine($"        bool HasErrors => {_debugLogs.Any(l => l.Contains("错误:")).ToString().ToLower()};");
            logContent.AppendLine();
            logContent.AppendLine("        /// <summary>详细日志条目</summary>");
            logContent.AppendLine("        IEnumerable<string> LogEntries => new List<string> {");

            // 添加日志条目
            foreach (var log in _debugLogs)
            {
                logContent.AppendLine($"            \"{log.Replace("\"", "\\\"")}\",");
            }

            logContent.AppendLine("        };");
            logContent.AppendLine("    }");
            logContent.AppendLine("}");

            context.AddSource("Logs/CodeMetaData_DebugLog.g.cs",
                SourceText.From(logContent.ToString(), Encoding.UTF8));
        }

        /// <summary>
        /// 报告生成错误
        /// </summary>
        private void ReportError(SourceProductionContext context, string message)
        {
            context.ReportDiagnostic(Diagnostic.Create(
                new DiagnosticDescriptor(
                    "CMD001", "元数据生成错误", message, "CodeMeta",
                    DiagnosticSeverity.Error, true),
                Location.None));
        }

        /// <summary>
        /// 带上下文的日志记录（支持诊断输出）
        /// </summary>
        private void LogDebug(SourceProductionContext context, string message)
        {
            LogDebug(message);
            context.ReportDiagnostic(Diagnostic.Create(
                new DiagnosticDescriptor(
                    "CMD000", "元数据生成调试", message, "CodeMeta",
                    DiagnosticSeverity.Info, true),
                Location.None));
        }
    }
}